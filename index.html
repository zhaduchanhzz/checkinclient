<!DOCTYPE html>
<html>
<head>
    <title>Search User</title>
    <style>
        #searchBox {
            width: 60%;
            max-width: 500px;
            padding: 20px 30px;
            font-size: 24px;
            border: 2px solid #ccc;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            outline: none;
            transition: all 0.3s ease;
            margin-bottom: 2%;
        }

        #searchBox:focus {
            border-color: #007BFF;
            box-shadow: 0 0 10px rgba(0,123,255,0.3);
        }

        ::placeholder {
            color: #aaa;
            font-style: italic;
        }
    </style>
</head>
<body>

<input type="text" id="searchBox" placeholder="Tìm theo tên hoặc mã đại biểu">
<br>
<select id="userDropdown" size="5" style="width: 300px;"></select>

<h2>Chọn đại biểu theo mã số</h2>
<div id="buttonArea"></div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    // Sample user data
    const users = [
        { id: "TA001", name: "La Hồng Hải", email: "1" },
        { id: "TA002", name: "Lê Thị Thanh Tâm", email: "2" },
        { id: "TA003", name: "Nguyễn Thị Chung", email: "3" }
    ];

    const dropdown = document.getElementById("userDropdown");
    const searchBox = document.getElementById("searchBox");
    const buttonArea = document.getElementById("buttonArea");

    let stompClient; // STOMP client instance

    // Function to establish WebSocket connection
    function connectWebSocket() {
        const socket = new SockJS('http://183.81.33.106:8088/ws', null, {
            headers: {
                'ngrok-skip-browser-warning': 'true' // ngrok skip header
            }
        });

        stompClient = Stomp.over(socket); // Use SockJS connection with STOMP protocol

        stompClient.connect({}, (frame) => {
            console.log("Connected to WebSocket", frame);

            // Once connected, we can start sending/receiving messages
            console.log("WebSocket connection established.");
        }, (error) => {
            console.error("WebSocket connection failed:", error);
        });
    }

    // Function to render users in dropdown
    function renderDropdown(filteredUsers) {
        dropdown.innerHTML = ''; // Clear existing options
        filteredUsers.forEach(user => {
            const option = document.createElement("option");
            option.value = user.id;
            option.text = `${user.name}`;
            dropdown.appendChild(option);
        });
    }

    // Function to render buttons for each user
    function renderButtons(userList) {
        buttonArea.innerHTML = ''; // Clear existing buttons
        userList.forEach(user => {
            const btn = document.createElement("button");
            btn.textContent = user.id;
            btn.style.margin = "5px";
            btn.onclick = () => handleUserSelect(user.id); // Handle button click
            buttonArea.appendChild(btn);
        });
    }

    // Function to handle user selection from dropdown or button click
    function handleUserSelect(userId) {
        const selectedUser = users.find(u => u.id === userId);
        if (selectedUser && stompClient.connected) {
            // Optionally highlight the selected user in dropdown
            dropdown.value = userId;

            // Send selected user data over WebSocket
            stompClient.send("/app/select", {}, JSON.stringify(selectedUser));
            console.log("User selected and sent:", selectedUser);
        } else {
            console.log("WebSocket is not connected or no user found");
        }
    }

    // Function to filter users based on the search query
    function filterUsers(query) {
        const q = query.toLowerCase();
        return users.filter(u =>
            u.id.toLowerCase().includes(q) ||
            u.name.toLowerCase().includes(q) ||
            u.email.toLowerCase().includes(q)
        );
    }

    // Listen for input in the search box and filter users
    searchBox.addEventListener("input", () => {
        const filtered = filterUsers(searchBox.value);
        renderDropdown(filtered); // Render filtered users in dropdown
    });

    // Listen for dropdown change and select user
    dropdown.addEventListener("change", () => {
        const selectedId = dropdown.value;
        handleUserSelect(selectedId); // Handle selection
    });

    // Initial render: Populate dropdown and buttons
    renderDropdown(users);
    renderButtons(users);

    // Connect to WebSocket server
    connectWebSocket();
</script>

</body>
</html>